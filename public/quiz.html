<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºæŒ‘æˆ¦ä¸­ï¼</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="player-status-container" style="display: none;">
        <h3>å‚åŠ è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
        <ul id="player-status-list"></ul>
    </div>

    <div class="container">
        <p id="progress" style="font-size: 1.2rem; font-weight: bold;"></p>
        <h2 id="question">ã‚¯ã‚¤ã‚ºã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</h2>
        <div id="options-container"></div>
        <div id="result"></div>
    </div>
    <button id="back-to-lobby-btn" class="secondary-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>

    <button id="chat-toggle-btn">ğŸ’¬</button>
    <div id="chat-panel">
        <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input id="chat-input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
            <button type="submit">é€ä¿¡</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const roomId = window.location.pathname.split('/')[2];
        
        const firebaseConfig = {
            apiKey: "AIzaSyDt92CKIkB48Bf6gXAlaeZYF7uNwT6gEp4",
            authDomain: "quizhokkaido.firebaseapp.com",
            projectId: "quizhokkaido",
            storageBucket: "quizhokkaido.firebasestorage.app",
            messagingSenderId: "570677049102",
            appId: "1:570677049102:web:d66b9d3a1e525d2428c95f",
            measurementId: "G-QZJDP1DB32"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const socket = io();

        let nextQuestionTimer = null;
        let hasProceeded = false;

        const progressEl = document.getElementById('progress');
        const questionEl = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const resultEl = document.getElementById('result');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const playerStatusContainer = document.getElementById('player-status-container');
        const playerStatusList = document.getElementById('player-status-list');

        socket.on('connect', () => {
            auth.onAuthStateChanged((user) => {
                const guestName = sessionStorage.getItem('guestName');
                if (user) {
                    user.getIdToken(true).then(idToken => {
                        socket.emit('player-ready', { roomId, idToken });
                    }).catch(err => { window.location.href = '/login'; });
                } else if (guestName) {
                    socket.emit('player-ready', { roomId, name: guestName });
                } else {
                    window.location.href = '/';
                }
            });
        });

        if(backToLobbyBtn) {
            backToLobbyBtn.addEventListener('click', () => {
                if (confirm('ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¦å…¨å“¡ã§ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                    socket.emit('return-to-lobby', { roomId });
                }
            });
        }

        socket.on('new-question', (data) => {
            hasProceeded = false;
            resultEl.innerHTML = '';
            optionsContainer.innerHTML = '';
            questionEl.style.display = 'block';
            if(backToLobbyBtn) backToLobbyBtn.disabled = false;
            
            progressEl.textContent = `ç¬¬ ${data.questionNumber} / ${data.totalQuestions} å•`;
            questionEl.textContent = data.question.question;

            playerStatusContainer.style.display = 'block';
            playerStatusList.innerHTML = '';
            data.users.forEach(user => {
                const li = document.createElement('li');
                li.id = 'status-' + user.name;
                li.innerHTML = `<span class="player-name">${user.name}</span><span class="player-answer-status">å›ç­”å¾…...</span>`;
                playerStatusList.appendChild(li);
            });

            if (data.answerFormat === 'multiple-choice') {
                data.options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.className = 'option-btn';
                    button.addEventListener('click', () => handleSubmit(optionText, data.question.question));
                    optionsContainer.appendChild(button);
                });
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'answer-input';
                input.placeholder = 'ã²ã‚‰ãŒãªã§å…¥åŠ›';
                input.autocomplete = 'off';
                const submitButton = document.createElement('button');
                submitButton.textContent = 'è§£ç­”ã™ã‚‹';
                submitButton.className = 'option-btn';
                const submitHandler = () => handleSubmit(input.value, data.question.question);
                submitButton.addEventListener('click', submitHandler);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); submitHandler(); }
                });
                optionsContainer.appendChild(input);
                optionsContainer.appendChild(submitButton);
                input.focus();
            }
        });

        function handleSubmit(answer, questionText) {
            if (!answer || !answer.trim()) return;
            socket.emit('submit-answer', { roomId, answer, questionText });
            Array.from(optionsContainer.children).forEach(child => child.disabled = true);
        }
        
        socket.on('player-answered', ({ name, isCorrect }) => {
            const playerLi = document.getElementById('status-' + name);
            if (playerLi) {
                const statusSpan = playerLi.querySelector('.player-answer-status');
                if (isCorrect) {
                    statusSpan.textContent = 'æ­£è§£';
                    statusSpan.classList.add('correct');
                } else {
                    statusSpan.textContent = 'ä¸æ­£è§£';
                    statusSpan.classList.add('incorrect');
                }
            }
        });

        socket.on('answer-result', ({ correct, correctAnswer, trivia }) => {
            questionEl.style.display = 'none';
            optionsContainer.innerHTML = '';
            resultEl.innerHTML = '';

            const resultContainer = document.createElement('div');
            resultContainer.className = 'result-container';

            const verdictEl = document.createElement('h3');
            verdictEl.className = 'result-verdict';
            resultContainer.appendChild(verdictEl);

            if (correct) {
                verdictEl.textContent = 'æ­£è§£ï¼';
                verdictEl.classList.add('correct');
            } else {
                verdictEl.textContent = 'æ®‹å¿µï¼';
                verdictEl.classList.add('incorrect');
                const correctAnswerEl = document.createElement('p');
                correctAnswerEl.className = 'result-correct-answer';
                correctAnswerEl.innerHTML = `æ­£è§£ã¯ã€Œ<span>${correctAnswer}</span>ã€ã§ã—ãŸã€‚`;
                resultContainer.appendChild(correctAnswerEl);
            }
            
            const triviaContainer = document.createElement('div');
            triviaContainer.className = 'result-trivia';
            triviaContainer.innerHTML = `<div class="result-trivia-title">ã€è±†çŸ¥è­˜ã€‘</div><p class="result-trivia-body">${trivia}</p>`;
            resultContainer.appendChild(triviaContainer);

            const promptEl = document.createElement('p');
            promptEl.id = 'result-prompt';
            promptEl.className = 'result-prompt';
            promptEl.textContent = 'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...';
            resultContainer.appendChild(promptEl);
            
            resultEl.appendChild(resultContainer);
        });

        socket.on('all-answers-in', () => {
            const promptEl = document.getElementById('result-prompt');
            if (promptEl) {
                promptEl.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã€ã¾ãŸã¯ Enterã‚­ãƒ¼ã§æ¬¡ã«é€²ã¿ã¾ã™ (7ç§’å¾Œã«è‡ªå‹•é€²è¡Œ)';
                promptEl.style.color = '#3498db';
            }
            startProceedTimer();
        });

        function proceedToNext() {
            if (hasProceeded) return;
            hasProceeded = true;

            clearTimeout(nextQuestionTimer);
            document.removeEventListener('click', proceedToNext);
            document.removeEventListener('keydown', handleKeydown);

            resultEl.textContent = 'æ¬¡ã®å•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™...';
            socket.emit('ready-for-next-question', { roomId });
        }

        function handleKeydown(e) {
            if (e.key === 'Enter') {
                proceedToNext();
            }
        }

        function startProceedTimer() {
            nextQuestionTimer = setTimeout(proceedToNext, 7000);
            document.addEventListener('click', proceedToNext);
            document.addEventListener('keydown', handleKeydown);
        }

        socket.on('lobby-redirect', (targetRoomId) => {
            alert('ã‚¯ã‚¤ã‚ºãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚');
            window.location.href = `/room/${targetRoomId}`;
        });

        socket.on('quiz-end', ({ finalResults, roomId }) => {
            playerStatusContainer.style.display = 'none';
            resultEl.textContent = 'ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼çµæœç”»é¢ã«ç§»å‹•ã—ã¾ã™...';
            sessionStorage.setItem('finalResults', JSON.stringify(finalResults));
            window.location.href = `/room/${roomId}/results`;
        });

        socket.on('join-error', (data) => {
            alert(data.message);
            window.location.href = '/';
        });

        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        if (chatToggleBtn) {
            chatToggleBtn.addEventListener('click', () => {
                chatPanel.classList.toggle('is-open');
            });
        }

        if (chatForm) {
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = chatInput.value;
                if (message) {
                    socket.emit('send-chat-message', { roomId, message });
                    chatInput.value = '';
                }
            });
        }

        socket.on('new-chat-message', ({ sender, message }) => {
            const p = document.createElement('p');
            const escapedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            p.innerHTML = `<strong>${sender}:</strong> ${escapedMessage}`;
            chatMessages.appendChild(p);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    </script>
</body>
</html>