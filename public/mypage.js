document.addEventListener('DOMContentLoaded', () => {
    // --- DOMË¶ÅÁ¥†„ÇíÂèñÂæó ---
    const userStatusDiv = document.getElementById('user-status');
    const loadingMessage = document.getElementById('loading-message');
    const usernameDisplay = document.getElementById('username-display');
    const levelDisplay = document.getElementById('level-display');
    const ratingDisplay = document.getElementById('rating-display');
    const xpDisplay = document.getElementById('xp-display');
    const xpNextDisplay = document.getElementById('xp-next-display');
    const xpProgress = document.getElementById('xp-progress');
    const achievementsCard = document.getElementById('achievements-card');
    const achRandomSelect = document.getElementById('ach-random-select');
    const achRandomInput = document.getElementById('ach-random-input');
    const countEasy = document.getElementById('count-easy');
    const countNormal = document.getElementById('count-normal');
    const countHard = document.getElementById('count-hard');
    const countSuper = document.getElementById('count-super');
    const countRandom = document.getElementById('count-random');
    const bioCard = document.getElementById('bio-card');
    const bioDisplay = document.getElementById('bio-display');
    const bioForm = document.getElementById('bio-form');
    const bioInput = document.getElementById('bio-input');
    const levelUpEffect = document.getElementById('level-up-effect');

    // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---

    const getXpForLevelUp = (level) => Math.floor(100 * Math.pow(level, 1.5));

    const animateNumber = (element, start, end, duration) => {
        let startTime = null;
        const step = (timestamp) => {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    };

    // --- „É°„Ç§„É≥„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°åÈñ¢Êï∞ ---
    const runXpAnimation = (oldStats, newStats) => {
        let currentLevel = oldStats.level;
        let currentXp = oldStats.xp;
        const newTotalXp = (getXpForLevelUp(newStats.level - 1) - getXpForLevelUp(oldStats.level)) + oldStats.xp + newStats.xp;


        const animateNextLevelUp = () => {
            const xpNeededForCurrentLevel = getXpForLevelUp(currentLevel);

            if (newStats.level > currentLevel) {
                const duration = 1000;

                xpProgress.style.transition = `width ${duration}ms ease-out`;
                xpProgress.style.width = '100%';
                animateNumber(xpDisplay, currentXp, xpNeededForCurrentLevel, duration);
                xpNextDisplay.textContent = `${xpNeededForCurrentLevel} / ${xpNeededForCurrentLevel}`;
                xpProgress.textContent = `100%`;

                setTimeout(() => {
                    levelUpEffect.classList.remove('level-up-hidden');
                    levelUpEffect.classList.add('show');
                    levelDisplay.classList.add('level-up-pop');
                    
                    setTimeout(() => {
                        currentLevel++;
                        levelDisplay.textContent = currentLevel;
                        levelUpEffect.classList.remove('show');
                        levelDisplay.classList.remove('level-up-pop');
                        xpProgress.style.transition = 'width 0s';
                        xpProgress.style.width = '0%';
                        
                        currentXp = 0;
                        
                        setTimeout(animateNextLevelUp, 100);
                    }, 1500);
                }, duration);
                
            } else {
                const xpNeededForFinalLevel = getXpForLevelUp(newStats.level);
                const finalPercentage = (newStats.xp / xpNeededForFinalLevel) * 100;
                const duration = 1000;
                
                setTimeout(() => {
                    xpProgress.style.transition = `width ${duration}ms ease-out`;
                    xpProgress.style.width = `${finalPercentage}%`;
                    animateNumber(xpDisplay, currentXp, newStats.xp, duration);
                    
                    let startXpNext = currentXp;
                    let startTime = null;
                    const step = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const progress = Math.min((timestamp - startTime) / duration, 1);
                        const animatedXp = Math.floor(progress * (newStats.xp - startXpNext) + startXpNext);
                        xpNextDisplay.textContent = `${animatedXp} / ${xpNeededForFinalLevel}`;
                        xpProgress.textContent = `${Math.floor((animatedXp / xpNeededForFinalLevel) * 100)}%`;
                        if (progress < 1) {
                            window.requestAnimationFrame(step);
                        }
                    };
                    window.requestAnimationFrame(step);

                    setTimeout(() => {
                        localStorage.setItem('userStats', JSON.stringify(newStatsWithUid));
                    }, duration);
                }, 100);
            }
        };
        
        animateNextLevelUp();
    };


    // --- „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ„Å®„É°„Ç§„É≥Âá¶ÁêÜ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            const userRef = db.collection('users').doc(user.uid);
            userRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const newStats = {
                        level: data.level || 1,
                        xp: data.xp || 0
                    };

                    usernameDisplay.textContent = data.username;
                    ratingDisplay.textContent = data.rating || 1500;
                    const bio = data.bio || "Ëá™Â∑±Á¥π‰ªãÊñá„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ";
                    bioDisplay.textContent = bio;
                    bioInput.value = data.bio || "";
                    bioCard.style.display = 'block';

                    if (data.achievements) {
                        const achData = data.achievements;
                        achRandomSelect.textContent = achData.perfectRandomSelect ? 'üèÜ ÈÅîÊàêÊ∏à„Åø' : 'Êú™ÈÅîÊàê';
                        achRandomInput.textContent = achData.perfectRandomInput ? 'üèÜ ÈÅîÊàêÊ∏à„Åø' : 'Êú™ÈÅîÊàê';
                        const counts = achData.perfectCounts || {};
                        const formatCountText = (difficultyKey) => {
                            const countData = counts[difficultyKey];
                            if (typeof countData === 'object' && countData !== null) {
                                const selectCount = countData.select || 0;
                                const inputCount = countData.input || 0;
                                return `ÈÅ∏Êäû ${selectCount}Âõû / ÂÖ•Âäõ ${inputCount}Âõû`;
                            }
                            if (typeof countData === 'number') {
                                return `ÂêàË®à ${countData}Âõû`;
                            }
                            return `ÈÅ∏Êäû 0Âõû / ÂÖ•Âäõ 0Âõû`;
                        };
                        countEasy.textContent = formatCountText('EASY');
                        countNormal.textContent = formatCountText('NORMAL');
                        countHard.textContent = formatCountText('HARD');
                        countSuper.textContent = formatCountText('SUPER');
                        countRandom.textContent = formatCountText('RANDOM');
                        achievementsCard.style.display = 'block';
                    }

                    loadingMessage.style.display = 'none';
                    userStatusDiv.style.display = 'block';

                    const oldStatsJSON = localStorage.getItem('userStats');
                    let oldStats = oldStatsJSON ? JSON.parse(oldStatsJSON) : null;
                    
                    if (oldStats && oldStats.uid !== user.uid) {
                        oldStats = null;
                    }

                    const newStatsWithUid = { ...newStats, uid: user.uid };

                    if (oldStats && (oldStats.xp !== newStats.xp || oldStats.level !== newStats.level)) {
                        levelDisplay.textContent = oldStats.level;
                        const xpNeededForOldLevel = getXpForLevelUp(oldStats.level);
                        const oldPercentage = (oldStats.xp / xpNeededForOldLevel) * 100;
                        xpProgress.style.width = `${oldPercentage}%`;
                        xpProgress.textContent = `${Math.floor(oldPercentage)}%`;
                        xpDisplay.textContent = oldStats.xp;
                        xpNextDisplay.textContent = `${oldStats.xp} / ${xpNeededForOldLevel}`;
                        
                        setTimeout(() => runXpAnimation(oldStats, newStats), 500);
                    } else {
                        levelDisplay.textContent = newStats.level;
                        const xpNeededForNewLevel = getXpForLevelUp(newStats.level);
                        const newPercentage = (newStats.xp / xpNeededForNewLevel) * 100;
                        xpProgress.style.width = `${newPercentage}%`;
                        xpProgress.textContent = `${Math.floor(newPercentage)}%`;
                        xpDisplay.textContent = newStats.xp;
                        xpNextDisplay.textContent = `${newStats.xp} / ${xpNeededForNewLevel}`;
                        localStorage.setItem('userStats', JSON.stringify(newStatsWithUid));
                    }

                } else {
                    loadingMessage.textContent = '„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                }
            }).catch(error => {
                console.error("„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Ç®„É©„Éº:", error);
                loadingMessage.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Å£„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            });
        } else {
            loadingMessage.textContent = '„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô...';
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        }
    });

    if (bioForm) {
        bioForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newBio = bioInput.value;
            const user = auth.currentUser;

            if (user) {
                const userRef = db.collection('users').doc(user.uid);
                userRef.update({
                    bio: newBio
                }).then(() => {
                    alert('Ëá™Â∑±Á¥π‰ªã„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                    bioDisplay.textContent = newBio;
                }).catch(error => {
                    console.error("Ëá™Â∑±Á¥π‰ªã„ÅÆÊõ¥Êñ∞„Ç®„É©„Éº:", error);
                    alert('Ëá™Â∑±Á¥π‰ªã„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                });
            }
        });
    }

    // Socket.IO„ÅÆÊé•Á∂ö„ÇíÂàùÊúüÂåñ
    const socket = io();

    // --- „É¶„Éº„Ç∂„ÉºÂêçÂ§âÊõ¥Âá¶ÁêÜ ---
    const usernameForm = document.getElementById('username-form');
    const usernameInput = document.getElementById('username-input');
    const usernameMessage = document.getElementById('username-message');

    if (usernameForm) {
        usernameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newUsername = usernameInput.value.trim();

            if (!newUsername) {
                usernameMessage.textContent = '„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                usernameMessage.style.color = 'red';
                return;
            }
            if (newUsername.length > 10) {
                usernameMessage.textContent = '„É¶„Éº„Ç∂„ÉºÂêç„ÅØ10ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                usernameMessage.style.color = 'red';
                return;
            }

            // „Çµ„Éº„Éê„Éº„Å´Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÈÄÅ‰ø°
            socket.emit('update-username', { newUsername });
            usernameMessage.textContent = 'Êõ¥Êñ∞‰∏≠...';
            usernameMessage.style.color = 'gray';
        });
    }

    // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÊàêÂäüÂøúÁ≠î
    socket.on('username-update-success', ({ newUsername }) => {
        usernameDisplay.textContent = newUsername; // ÁîªÈù¢‰∏ä„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        usernameMessage.textContent = '„É¶„Éº„Ç∂„ÉºÂêç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ';
        usernameMessage.style.color = 'green';
        usernameInput.value = ''; // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇÇÊõ¥Êñ∞Ôºà‰ªªÊÑèÔºâ
        const oldStatsJSON = localStorage.getItem('userStats');
        if (oldStatsJSON) {
            const stats = JSON.parse(oldStatsJSON);
            stats.username = newUsername;
            localStorage.setItem('userStats', JSON.stringify(stats));
        }
    });

    // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„Ç®„É©„ÉºÂøúÁ≠î
    socket.on('username-update-error', ({ message }) => {
        usernameMessage.textContent = message;
        usernameMessage.style.color = 'red';
    });
});