<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…æ©Ÿãƒ«ãƒ¼ãƒ </title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1 id="room-title">å¾…æ©Ÿä¸­ã®å‚åŠ è€…</h1>
    <ul id="userList"></ul>

    <div id="difficulty-selector">
        <h3>é›£æ˜“åº¦ã‚’é¸æŠ</h3>
        <div class="difficulty-options">
            <input type="radio" name="difficulty" value="EASY" id="diff-easy" checked>
            <label for="diff-easy">EASY</label>
            <input type="radio" name="difficulty" value="NORMAL" id="diff-normal">
            <label for="diff-normal">NORMAL</label>
            <input type="radio" name="difficulty" value="HARD" id="diff-hard">
            <label for="diff-hard">HARD</label>
            <input type="radio" name="difficulty" value="SUPER" id="diff-super">
            <label for="diff-super">SUPER</label>
            <input type="radio" name="difficulty" value="RANDOM" id="diff-random">
            <label for="diff-random">ãƒ©ãƒ³ãƒ€ãƒ </label>
        </div>
    </div>

    <div id="format-selector">
        <h3>è§£ç­”å½¢å¼ã‚’é¸æŠ</h3>
        <div class="format-options">
            <input type="radio" name="answerFormat" value="multiple-choice" id="format-mc" checked>
            <label for="format-mc">é¸æŠå¼</label>
            <input type="radio" name="answerFormat" value="text-input" id="format-text">
            <label for="format-text">å…¥åŠ›å¼</label>
        </div>
    </div>

    <div id="match-type-selector" style="margin-top: 2rem;">
        <button id="start-ranked-button" class="auth-button">ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒã§é–‹å§‹ï¼</button>
        <button id="start-free-button" class="auth-button" style="background-color: #27ae60;">ãƒ•ãƒªãƒ¼ãƒãƒƒãƒã§é–‹å§‹</button>
    </div>
    
    <a href="/" class="secondary-btn" style="margin-top: 1rem;">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <button id="chat-toggle-btn">ğŸ’¬</button>
  <div id="chat-panel">
      <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
      <div id="chat-messages"></div>
      <form id="chat-form">
          <input id="chat-input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
          <button type="submit">é€ä¿¡</button>
      </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    const roomId = window.location.pathname.split('/')[2];
    document.getElementById('room-title').textContent = `å¾…æ©Ÿéƒ¨å±‹: ${roomId}`;
    
    const firebaseConfig = {
        apiKey: "AIzaSyDt92CKIkB48Bf6gXAlaeZYF7uNwT6gEp4",
        authDomain: "quizhokkaido.firebaseapp.com",
        projectId: "quizhokkaido",
        storageBucket: "quizhokkaido.firebasestorage.app",
        messagingSenderId: "570677049102",
        appId: "1:570677049102:web:d66b9d3a1e525d2428c95f",
        measurementId: "G-QZJDP1DB32"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    const socket = io();

    socket.on('connect', () => {
        auth.onAuthStateChanged((user) => {
            const guestName = sessionStorage.getItem('guestName');
            if (user) {
                user.getIdToken(true).then(idToken => {
                    socket.emit('join-room', { roomId, idToken });
                }).catch(error => {
                    console.error("èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                    alert('èªè¨¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = '/login';
                });
            } else if (guestName) {
                socket.emit('join-room', { roomId, name: guestName });
            } else {
                alert('å‚åŠ æƒ…å ±ãŒãªã„ãŸã‚ã€ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚');
                window.location.href = '/';
            }
        });
    });

    socket.on('room-users', (users) => {
        const ul = document.getElementById('userList');
        if(!ul) return;
        ul.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.textContent = `${u.name} (Lv. ${u.level}) ${u.isGuest ? '(ã‚²ã‚¹ãƒˆ)' : ''}`;
            ul.appendChild(li);
        });
    });

    const startRankedButton = document.getElementById('start-ranked-button');
    const startFreeButton = document.getElementById('start-free-button');

    function startQuiz(isRanked) {
        startRankedButton.disabled = true;
        startFreeButton.disabled = true;
        startRankedButton.textContent = 'æº–å‚™ä¸­...';
        startFreeButton.textContent = 'æº–å‚™ä¸­...';

        const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
        const selectedFormat = document.querySelector('input[name="answerFormat"]:checked').value;
        
        socket.emit('start-quiz', { 
            roomId, 
            difficulty: selectedDifficulty, 
            answerFormat: selectedFormat,
            isRanked: isRanked
        });
    }

    if (startRankedButton && startFreeButton) {
        startRankedButton.addEventListener('click', () => startQuiz(true));
        startFreeButton.addEventListener('click', () => startQuiz(false));
    }

    socket.on('quiz-start', ({ roomId }) => {
        window.location.href = `/room/${roomId}/quiz`;
    });
    
    socket.on('quiz-start-failed', (data) => {
        alert(data.message);
        if (startRankedButton && startFreeButton) {
            startRankedButton.disabled = false;
            startFreeButton.disabled = false;
            startRankedButton.textContent = 'ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒã§é–‹å§‹ï¼';
            startFreeButton.textContent = 'ãƒ•ãƒªãƒ¼ãƒãƒƒãƒã§é–‹å§‹';
        }
    });

    socket.on('join-error', (data) => {
        alert(data.message);
        window.location.href = '/';
    });

    const chatToggleBtn = document.getElementById('chat-toggle-btn');
    const chatPanel = document.getElementById('chat-panel');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    if (chatToggleBtn) {
        chatToggleBtn.addEventListener('click', () => {
            chatPanel.classList.toggle('is-open');
        });
    }

    if (chatForm) {
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value;
            if (message) {
                socket.emit('send-chat-message', { roomId, message });
                chatInput.value = '';
            }
        });
    }

    socket.on('new-chat-message', ({ sender, message }) => {
        const p = document.createElement('p');
        const escapedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        p.innerHTML = `<strong>${sender}:</strong> ${escapedMessage}`;
        chatMessages.appendChild(p);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  </script>
</body>
</html>